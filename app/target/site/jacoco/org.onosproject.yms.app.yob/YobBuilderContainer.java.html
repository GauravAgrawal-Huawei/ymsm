<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>YobBuilderContainer.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">onos-app-yms</a> &gt; <a href="index.source.html" class="el_package">org.onosproject.yms.app.yob</a> &gt; <span class="el_source">YobBuilderContainer.java</span></div><h1>YobBuilderContainer.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2016-present Open Networking Laboratory
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.onosproject.yms.app.yob;

import java.util.HashMap;
import java.util.Map;

import org.onosproject.yangutils.datamodel.RpcNotificationContainer;
import org.onosproject.yangutils.datamodel.YangNode;
import org.onosproject.yangutils.datamodel.YangSchemaNode;
import org.onosproject.yangutils.datamodel.YangSchemaNodeContextInfo;
import org.onosproject.yangutils.datamodel.YangSchemaNodeIdentifier;
import org.onosproject.yangutils.datamodel.exceptions.DataModelException;
import org.onosproject.yms.app.ydt.YdtExtendedContext;
import org.onosproject.yms.app.yob.exception.YobExceptions;
import org.onosproject.yms.app.ysr.YangSchemaRegistry;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import static org.onosproject.yangutils.datamodel.YangSchemaNodeType.YANG_AUGMENT_NODE;
import static org.onosproject.yangutils.datamodel.YangSchemaNodeType.YANG_CHOICE_NODE;
import static org.onosproject.yangutils.utils.io.impl.YangIoUtils.getCapitalCase;
import static org.onosproject.yms.app.yob.YobConstants.DEFAULT;
import static org.onosproject.yms.app.yob.YobConstants.OPPARAM;


/**
 * Represents the YANG object builder's work bench corresponding to a YANG data
 * tree node.
 */
public class YobBuilderContainer {

<span class="fc" id="L47">    private static final Logger log</span>
<span class="fc" id="L48">            = LoggerFactory.getLogger(YobBuilderContainer.class);</span>

    /**
     * Class loader to be used to load the class.
     */
    private ClassLoader registeredAppClassLoader;

    /**
     * Map of the non schema descendent builders.
     */
<span class="fc" id="L58">    Map&lt;YangSchemaNodeIdentifier, YobBuilderContainer&gt; builderContainerMap</span>
            = new HashMap&lt;&gt;();

    /**
     * Reference for data-model schema node.
     */
    private YangSchemaNode yangSchemaNode;

    /**
     * builder object or the built object corresponding to the current schema
     * node.
     */
    private YobBuilderOrBuiltObject builderOrBuiltObjectOfScheam;

    private String setterMethodNameInParent;

    /**
     * Returns the builder container with the mapping schema being initialized.
     *
     * @param yangSchemaNode mapping schema node
     */
    public YobBuilderContainer(YangSchemaNode yangSchemaNode,
                               ClassLoader registeredAppClassLoader,
                               String qualifiedClassName,
<span class="fc" id="L82">                               String setterMethodNameInParent) {</span>
<span class="fc" id="L83">        this.yangSchemaNode = yangSchemaNode;</span>
<span class="fc" id="L84">        setRegisteredAppClassLoader(registeredAppClassLoader);</span>
<span class="fc" id="L85">        this.setterMethodNameInParent = setterMethodNameInParent;</span>

<span class="fc" id="L87">        setBuilderOrBuiltObjectOfScheam(</span>
                new YobBuilderOrBuiltObject(qualifiedClassName,
<span class="fc" id="L89">                                            getRegisteredAppClassLoader()));</span>
<span class="fc" id="L90">    }</span>

    /**
     * Returns the mapping schema node.
     *
     * @return mapping schema node
     */
    public YangSchemaNode getYangSchemaNode() {
<span class="fc" id="L98">        return yangSchemaNode;</span>
    }


    /**
     * Returns the builder object or the built object corresponding to the
     * current schema node.
     *
     * @return builder or built object
     */
    public YobBuilderOrBuiltObject getBuilderOrBuiltObjectOfScheam() {
<span class="fc" id="L109">        return builderOrBuiltObjectOfScheam;</span>
    }

    /**
     * Sets the builder object or the built object corresponding to the
     * current schema node.
     *
     * @param builderOrBuiltObjectOfScheam builder or built object
     */
    public void setBuilderOrBuiltObjectOfScheam(
            YobBuilderOrBuiltObject builderOrBuiltObjectOfScheam) {
<span class="fc" id="L120">        this.builderOrBuiltObjectOfScheam = builderOrBuiltObjectOfScheam;</span>
<span class="fc" id="L121">    }</span>

    /**
     * Returns registered application's class loader.
     *
     * @return registered application's class loader
     */
    private ClassLoader getRegisteredAppClassLoader() {
<span class="fc" id="L129">        return registeredAppClassLoader;</span>
    }

    /**
     * Sets registered application's class loader.
     *
     * @param registeredAppClassLoader registered application's class loader
     */
    private void setRegisteredAppClassLoader(
            ClassLoader registeredAppClassLoader) {
<span class="fc" id="L139">        this.registeredAppClassLoader = registeredAppClassLoader;</span>
<span class="fc" id="L140">    }</span>

    /**
     * Returns the parent builder object in which the child object can be set.
     *
     * @param childYdtNode child YDT node
     * @param registry     schema registry
     * @return parent builder object
     */
    public Object getParentBuilderObjectFromAncestor(
            YdtExtendedContext childYdtNode,
            YangSchemaRegistry registry) {

        /*
         * Descendent schema node for whom the builder is required.
         */
<span class="fc" id="L156">        YangSchemaNodeIdentifier descendentSchemaIdentifier = childYdtNode</span>
<span class="fc" id="L157">                .getYangSchemaNode().getYangSchemaNodeIdentifier();</span>

        //Current builder container
<span class="fc" id="L160">        YobBuilderContainer curBuilderContainer = this;</span>

        //Current Schema node context
<span class="fc" id="L163">        YangSchemaNodeContextInfo descendentSchemaContext = null;</span>
        do {

            try {
                //Find the new schema context node.
<span class="fc" id="L168">                descendentSchemaContext =</span>
<span class="fc" id="L169">                        curBuilderContainer.getYangSchemaNode()</span>
<span class="fc" id="L170">                                .getChildSchema(descendentSchemaIdentifier);</span>
<span class="nc" id="L171">            } catch (DataModelException e) {</span>
<span class="nc" id="L172">                throw new YobExceptions(getYangSchemaNode().getName()</span>
                                                + &quot; does not have child &quot; +
                                                descendentSchemaIdentifier
<span class="nc" id="L175">                                                        .getName());</span>
<span class="fc" id="L176">            }</span>

            //If the descendent schema node is in switched context
<span class="pc bpc" id="L179" title="1 of 2 branches missed.">            if (descendentSchemaContext.getContextSwitchedNode() != null) {</span>

                //check if the descendent builder container is already available
<span class="nc" id="L182">                YobBuilderContainer descendentBuilderContainer =</span>
<span class="nc" id="L183">                        curBuilderContainer.builderContainerMap.get(</span>
                                descendentSchemaIdentifier);
<span class="nc bnc" id="L185" title="All 2 branches missed.">                if (descendentBuilderContainer == null) {</span>
<span class="nc" id="L186">                    YobBuilderContainer newBuilderContainer =</span>
<span class="nc" id="L187">                            getNewDescendentBuilderContainer(</span>
                                    descendentSchemaContext,
                                    descendentSchemaIdentifier,
                                    curBuilderContainer, registry);
<span class="nc" id="L191">                    curBuilderContainer.builderContainerMap</span>
<span class="nc" id="L192">                            .put(descendentSchemaIdentifier, newBuilderContainer);</span>
<span class="nc" id="L193">                    curBuilderContainer = newBuilderContainer;</span>
<span class="nc" id="L194">                } else {</span>
<span class="nc" id="L195">                    curBuilderContainer = descendentBuilderContainer;</span>
                }
            }

<span class="pc bpc" id="L199" title="1 of 2 branches missed.">        } while (descendentSchemaContext.getContextSwitchedNode() != null);</span>

<span class="fc" id="L201">        return curBuilderContainer.getBuilderOrBuiltObjectOfScheam()</span>
<span class="fc" id="L202">                .getBuilderObject();</span>
    }

    /**
     * Creates a new builder container object corresponding to a context
     * switch schema node.
     *
     * @param descendentSchemaContext    schema context of immediate descedent
     * @param descendentSchemaIdentifier final node whose parent builder is
     *                                   requried
     * @param curBuilderContainer        current context bulter container
     * @param registry                   schema registry
     * @return new builder container object corresponding to a context
     * switch schema node.
     */
    private YobBuilderContainer getNewDescendentBuilderContainer(
            YangSchemaNodeContextInfo descendentSchemaContext,
            YangSchemaNodeIdentifier descendentSchemaIdentifier,
            YobBuilderContainer curBuilderContainer,
            YangSchemaRegistry registry) {

         /*This is the first descendent trying to set its object in the
         current context. */
<span class="nc" id="L225">        String setterMethodNameInParent = descendentSchemaContext</span>
<span class="nc" id="L226">                .getContextSwitchedNode().getJavaAttributeName();</span>

        /* If current switched context is choice, then case class needs to be
         used. */
<span class="nc" id="L230">        if (descendentSchemaContext.getContextSwitchedNode()</span>
<span class="nc bnc" id="L231" title="All 2 branches missed.">                .getYangSchemaNodeType() == YANG_CHOICE_NODE) {</span>
            try {
<span class="nc" id="L233">                descendentSchemaContext =</span>
                        descendentSchemaContext
<span class="nc" id="L235">                                .getContextSwitchedNode()</span>
<span class="nc" id="L236">                                .getChildSchema(</span>
                                        descendentSchemaIdentifier);
<span class="nc" id="L238">            } catch (DataModelException e) {</span>
<span class="nc" id="L239">                throw new YobExceptions(</span>
<span class="nc" id="L240">                        getYangSchemaNode().getName()</span>
                                + &quot; does not have child &quot; +
                                descendentSchemaIdentifier
<span class="nc" id="L243">                                        .getName());</span>
<span class="nc" id="L244">            }</span>
        }

<span class="nc" id="L247">        ClassLoader newClassesLoader</span>
<span class="nc" id="L248">                = getContextSwitchClassLoader(curBuilderContainer</span>
<span class="nc" id="L249">                                                      .getRegisteredAppClassLoader(),</span>
                                              descendentSchemaContext,
                                              registry);

<span class="nc" id="L253">        return new YobBuilderContainer(descendentSchemaContext</span>
<span class="nc" id="L254">                                               .getContextSwitchedNode(),</span>
                                       newClassesLoader,
<span class="nc" id="L256">                                       getQualifiedDefaultClassName(</span>
                                               descendentSchemaContext
<span class="nc" id="L258">                                                       .getSchemaNode()),</span>
                                       setterMethodNameInParent);
    }

    /**
     * Returns the qualified default / op param class.
     *
     * @param schemaNode schema node of the required class
     * @return qualified default / op param class name
     */
    static String getQualifiedDefaultClassName(YangSchemaNode schemaNode) {
<span class="fc" id="L269">        String packageName = schemaNode.getJavaPackage();</span>
<span class="fc" id="L270">        String className =</span>
<span class="fc" id="L271">                schemaNode.getJavaClassNameOrBuiltInType();</span>
<span class="fc" id="L272">        className = getCapitalCase(className);</span>
        String qualifiedClassName;
<span class="fc" id="L274">        boolean isRootNode = schemaNode instanceof RpcNotificationContainer;</span>
<span class="fc bfc" id="L275" title="All 2 branches covered.">        if (isRootNode) {</span>
<span class="fc" id="L276">            qualifiedClassName =</span>
                    packageName + &quot;.&quot; + className + OPPARAM;
        } else {
<span class="fc" id="L279">            qualifiedClassName =</span>
                    packageName + &quot;.&quot; + DEFAULT + className;
        }

<span class="fc" id="L283">        return qualifiedClassName;</span>
    }

    /**
     * Returns the class loader to be used for the switched context schema node.
     *
     * @param currentClassLoader current context class loader
     * @param switchedContext    switched context
     * @param registry           schema registry
     * @return class loader to be used for the switched context schema node
     */
    private ClassLoader getContextSwitchClassLoader(
            ClassLoader currentClassLoader,
            YangSchemaNodeContextInfo switchedContext,
            YangSchemaRegistry registry) {

<span class="nc bnc" id="L299" title="All 2 branches missed.">        if (switchedContext.getSchemaNode().getYangSchemaNodeType() ==</span>
                YANG_AUGMENT_NODE) {
<span class="nc" id="L301">            YangSchemaNode augmentSchemaNode = switchedContext.getSchemaNode();</span>
<span class="nc" id="L302">            YangSchemaNode parentSchemaNode =</span>
<span class="nc" id="L303">                    ((YangNode) augmentSchemaNode).getParent();</span>

<span class="nc" id="L305">            Class&lt;?&gt; regClass = registry.getRegisteredClass(parentSchemaNode,</span>
<span class="nc" id="L306">                                                            getCapitalCase(</span>
                                                                    parentSchemaNode
<span class="nc" id="L308">                                                                            .getJavaClassNameOrBuiltInType()));</span>
<span class="nc" id="L309">            return regClass.getClassLoader();</span>
        }

<span class="nc" id="L312">        return currentClassLoader;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>
<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>YchYangDataTreeCodec.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">onos-app-yms</a> &gt; <a href="index.source.html" class="el_package">org.onosproject.yms.app.ych.codecutils</a> &gt; <span class="el_source">YchYangDataTreeCodec.java</span></div><h1>YchYangDataTreeCodec.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2016-present Open Networking Laboratory
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.onosproject.yms.app.ych.codecutils;

import java.util.Iterator;
import java.util.Map;

import org.dom4j.Document;
import org.dom4j.DocumentException;
import org.dom4j.DocumentHelper;
import org.dom4j.Element;
import org.dom4j.Namespace;
import org.onosproject.yms.app.ydt.DefaultYdtWalker;
import org.onosproject.yms.app.ydt.YangRequestWorkBench;
import org.onosproject.yms.app.ydt.YdtExtendedBuilder;
import org.onosproject.yms.app.ydt.YdtExtendedWalker;
import org.onosproject.yms.app.ysr.YangSchemaRegistry;
import org.onosproject.yms.ych.YangCompositeEncoding;
import org.onosproject.yms.ych.YangDataTreeCodec;
import org.onosproject.yms.ych.YangProtocolEncodingFormat;
import org.onosproject.yms.ydt.YdtBuilder;
import org.onosproject.yms.ydt.YmsOperationType;

import static org.onosproject.yms.app.ych.codecutils.CodecUtilConstants.CONFIG;
import static org.onosproject.yms.app.ych.codecutils.CodecUtilConstants.DATA;
import static org.onosproject.yms.app.ych.codecutils.CodecUtilConstants
        .EDITCONFIG;
import static org.onosproject.yms.app.ych.codecutils.CodecUtilConstants.FILTER;
import static org.onosproject.yms.app.ych.codecutils.CodecUtilConstants.GET;
import static org.onosproject.yms.app.ych.codecutils.CodecUtilConstants
        .GETCONFIG;
import static org.onosproject.yms.ydt.YmsOperationType.EDIT_CONFIG_REQUEST;
import static org.onosproject.yms.ydt.YmsOperationType.QUERY_CONFIG_REQUEST;
import static org.onosproject.yms.ydt.YmsOperationType.QUERY_REQUEST;

/**
 * Represents an YCH data tree codec.
 */
public class YchYangDataTreeCodec
        implements YangDataTreeCodec {

    /**
     * Root element node used for YDT buider.
     */
    private Element rootElement;

    /**
     * Root element name space.
     */
    private String rootNameSpace;

    /**
     * Interaction type received from driver.
     */
    private YmsOperationType yangInteractionType;

    /**
     * Returns the root element node.
     *
     * @return the root element node
     */
    private Element getRootElement() {
<span class="fc" id="L77">        return rootElement;</span>
    }

    /**
     * Sets the root element node.
     *
     * @param rootElement the root element node
     */
    private void setRootElement(Element rootElement) {
<span class="fc" id="L86">        this.rootElement = rootElement;</span>
<span class="fc" id="L87">    }</span>

    /**
     * Returns the root element namespace.
     *
     * @return the root element namespace
     */
    public String getRootNameSpace() {
<span class="fc" id="L95">        return rootNameSpace;</span>
    }

    /**
     * Sets the root element namespace.
     *
     * @param rootNameSpace the root element namespace
     */
    public void setRootNameSpace(String rootNameSpace) {
<span class="fc" id="L104">        this.rootNameSpace = rootNameSpace;</span>
<span class="fc" id="L105">    }</span>

    /**
     * Returns the YANG interaction type.
     *
     * @return the YANG interaction type
     */
    private YmsOperationType getYangInteractionType() {
<span class="nc" id="L113">        return yangInteractionType;</span>
    }

    /**
     * Sets the YANG interaction type.
     *
     * @param yangInteractionType the YANG interaction type
     */
    private void setYangInteractionType(YmsOperationType yangInteractionType) {
<span class="fc" id="L122">        this.yangInteractionType = yangInteractionType;</span>
<span class="fc" id="L123">    }</span>

    /**
     * Creates a new YANG application broker.
     */
<span class="fc" id="L128">    public YchYangDataTreeCodec() {</span>
<span class="fc" id="L129">    }</span>

    @Override
    public String encodeYdtToProtocolFormat(YdtBuilder ydtBuilder,
                                            YmsOperationType
                                                    protocolOperation) {
<span class="fc" id="L135">        YdtExtendedBuilder ydtExtendedBuilder = (YdtExtendedBuilder) ydtBuilder;</span>
<span class="fc" id="L136">        CodecYdtListener codecYdtListener = new CodecYdtListener();</span>
<span class="fc" id="L137">        codecYdtListener</span>
<span class="fc" id="L138">                .setRecvedDataFormat(YangProtocolEncodingFormat.XML_ENCODING);</span>
<span class="fc" id="L139">        codecYdtListener.setRootYdtNode(ydtExtendedBuilder.getRootNode());</span>

        // Creating the root element for xml.
<span class="fc" id="L142">        Element rootElement = DocumentHelper.createDocument()</span>
<span class="fc" id="L143">                .addElement(ydtExtendedBuilder.getRootNode().getName());</span>

        // Adding the name space if exist for root name.
<span class="pc bpc" id="L146" title="1 of 2 branches missed.">        if (ydtExtendedBuilder.getRootNode().getNamespace() != null) {</span>
<span class="fc" id="L147">            Namespace namespace = Namespace</span>
<span class="fc" id="L148">                    .get(ydtExtendedBuilder.getRootNode().getNamespace());</span>
<span class="fc" id="L149">            rootElement.add(namespace);</span>
        }

        // Adding the attribute if exist
<span class="fc" id="L153">        Map&lt;String, String&gt; tagAttributeLinkedMap =</span>
<span class="fc" id="L154">                ydtExtendedBuilder.getRootTagAttributeMap();</span>
<span class="fc bfc" id="L155" title="All 2 branches covered.">        if ((tagAttributeLinkedMap != null) &amp;&amp;</span>
<span class="pc bpc" id="L156" title="1 of 2 branches missed.">                !tagAttributeLinkedMap.isEmpty()) {</span>
<span class="fc bfc" id="L157" title="All 2 branches covered.">            for (Map.Entry&lt;String, String&gt; attribute : tagAttributeLinkedMap</span>
<span class="fc" id="L158">                    .entrySet()) {</span>
<span class="fc" id="L159">                rootElement</span>
<span class="fc" id="L160">                        .addAttribute(attribute.getKey(), attribute.getValue());</span>
<span class="fc" id="L161">            }</span>
        }

<span class="fc" id="L164">        codecYdtListener.getDomElementStack().push(rootElement);</span>

        // Walk through YDT and build the xml.
<span class="fc" id="L167">        YdtExtendedWalker ydtExtendedWalker = new DefaultYdtWalker();</span>
<span class="pc bpc" id="L168" title="1 of 2 branches missed.">        if (ydtExtendedBuilder.getRootNode() != null) {</span>
<span class="fc" id="L169">            ydtExtendedWalker</span>
<span class="fc" id="L170">                    .walk(codecYdtListener, ydtExtendedBuilder.getRootNode());</span>
        }

<span class="fc" id="L173">        return rootElement.asXML();</span>
    }

    @Override
    public YangCompositeEncoding encodeYdtToCompositeProtocolFormat(
            YdtBuilder ydtBuilder,
            YmsOperationType protocolOperation) {

<span class="fc" id="L181">        String errorInfo = &quot;Encode for composite protocol request not supported.&quot;;</span>
<span class="fc" id="L182">        throw new YchException(errorInfo);</span>
    }

    @Override
    public YdtBuilder decodeCompositeProtocolDataToYdt(
            YangCompositeEncoding protocolData,
            Object schemaRegistryForYdt,
            YmsOperationType protocolOperation) {

<span class="fc" id="L191">        String errorInfo = &quot;Decode for composite protocol request not supported.&quot;;</span>
<span class="fc" id="L192">        throw new YchException(errorInfo);</span>
    }

    @Override
    public YdtBuilder decodeProtocolDataToYdt(String protocolData,
                                              Object schemaRegistry,
                                              YmsOperationType
                                                      protocolOperation) {
<span class="fc" id="L200">        YdtExtendedBuilder ydtExtendedBuilder = null;</span>
<span class="fc" id="L201">        Document document = null;</span>

        try {
<span class="fc" id="L204">            document = DocumentHelper.parseText(protocolData);</span>
<span class="nc" id="L205">        } catch (DocumentException e) {</span>
<span class="nc" id="L206">            String errorInfo = &quot;Root element in XML input string is not well-formed.&quot;;</span>
<span class="nc" id="L207">            throw new YchException(errorInfo);</span>
<span class="fc" id="L208">        }</span>
<span class="fc" id="L209">        XmlWalker walker = new DefaultXmlCodecWalker();</span>
<span class="fc" id="L210">        XmlCodecListener listener = new XmlCodecListener();</span>

        // Find the root element in xml string
<span class="fc" id="L213">        findRootElement(document.getRootElement());</span>
<span class="pc bpc" id="L214" title="1 of 2 branches missed.">        if (getRootElement() == null) {</span>
<span class="nc" id="L215">            String errorInfo = &quot;Root element (filter, config, data) in XML input string is not found.&quot;;</span>
<span class="nc" id="L216">            throw new YchException(errorInfo);</span>
        }

        // Get the YDT builder for the logical root name.
<span class="pc bpc" id="L220" title="1 of 2 branches missed.">        if (getRootElement() != null) {</span>
<span class="fc" id="L221">            ydtExtendedBuilder =</span>
<span class="fc" id="L222">                    new YangRequestWorkBench(getRootElement().getName(),</span>
<span class="fc" id="L223">                                             getRootNameSpace(),</span>
                                             protocolOperation,
                                             (YangSchemaRegistry)
                                                     schemaRegistry,
                                             false);
        }

<span class="fc" id="L230">        listener.setYdtExtendedBuilder(ydtExtendedBuilder);</span>
        // Walk through xml and build the yang data tree.
<span class="fc" id="L232">        walker.walk(listener, getRootElement(), getRootElement());</span>
<span class="fc" id="L233">        return ydtExtendedBuilder;</span>
    }

    /**
     * Find the root node element from the xml string.
     *
     * @param element input element to be traveresed to find the root node
     */
    private void findRootElement(Element element) {

        try {

<span class="pc bpc" id="L245" title="3 of 14 branches missed.">            switch (element.getName()) {</span>
                // edit-config tag name is found in xml then set the
                // interaction type.
                case EDITCONFIG: {
<span class="fc" id="L249">                    setYangInteractionType(EDIT_CONFIG_REQUEST);</span>
<span class="fc" id="L250">                    break;</span>
                }

                // get-config tag name is found in xml then set the
                // interaction type.
                case GETCONFIG: {
<span class="fc" id="L256">                    setYangInteractionType(QUERY_CONFIG_REQUEST);</span>
<span class="fc" id="L257">                    break;</span>
                }

                // get tag name is found in xml then set the interaction type.
                case GET: {
<span class="fc" id="L262">                    setYangInteractionType(QUERY_REQUEST);</span>
<span class="fc" id="L263">                    break;</span>
                }

                default: {
                    //TODO
                }
            }

            // If config tag name is found then set the root element node.
<span class="fc bfc" id="L272" title="All 2 branches covered.">            if (CONFIG.equals(element.getName()) ||</span>
<span class="fc bfc" id="L273" title="All 2 branches covered.">                    DATA.equals(element.getName())</span>
<span class="fc bfc" id="L274" title="All 2 branches covered.">                    || FILTER.equals(element.getName())) {</span>
<span class="fc" id="L275">                setRootElement(element);</span>
<span class="pc bpc" id="L276" title="1 of 2 branches missed.">                if (element.getNamespace() != null) {</span>
<span class="fc" id="L277">                    setRootNameSpace(element.getNamespace().getURI());</span>
                }
<span class="fc" id="L279">                return;</span>
            }

            /* If element has child node then traverse through the child node
             by recursivly calling
            findRootElement method. */
<span class="pc bpc" id="L285" title="1 of 4 branches missed.">            if (element.hasContent() &amp;&amp; !element.isTextOnly()) {</span>
<span class="fc bfc" id="L286" title="All 2 branches covered.">                for (Iterator i = element.elementIterator(); i.hasNext();</span>
<span class="fc" id="L287">                     i = i) {</span>
<span class="fc" id="L288">                    Element childElement = (Element) i.next();</span>
<span class="fc" id="L289">                    findRootElement(childElement);</span>
                }
            }

<span class="nc" id="L293">        } catch (Exception e) {</span>
            // TODO
<span class="fc" id="L295">        }</span>

<span class="fc" id="L297">        return;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>